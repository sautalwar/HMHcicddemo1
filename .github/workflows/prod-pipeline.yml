name: Production Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (e.g., rc-20260112-143022)'
        required: true
        type: string
      deployment_window:
        description: 'Deployment window (maintenance/business-hours)'
        required: true
        type: choice
        options:
          - maintenance
          - business-hours

env:
  NODE_VERSION: '18.x'
  AZURE_WEBAPP_NAME: github-demo-prod

jobs:
  pre-deployment-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Validate release tag
        run: |
          echo "Deploying release: ${{ inputs.release_tag }}"
          echo "Deployment window: ${{ inputs.deployment_window }}"
          
          # Verify it's a release candidate tag
          if [[ ! "${{ inputs.release_tag }}" =~ ^rc- ]]; then
            echo "Error: Only release candidate tags (rc-*) can be deployed to production"
            exit 1
          fi

      - name: Check deployment window
        run: |
          current_hour=$(date +%H)
          
          if [ "${{ inputs.deployment_window }}" == "maintenance" ]; then
            # Maintenance window: 2 AM - 6 AM UTC
            if [ $current_hour -lt 2 ] || [ $current_hour -gt 6 ]; then
              echo "Warning: Outside maintenance window (2 AM - 6 AM UTC)"
            fi
          fi

      - name: Fetch release notes
        run: |
          git log -1 --pretty=format:"%s%n%b" ${{ inputs.release_tag }}

  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all tests
        run: npm test
        env:
          DB_SERVER: ${{ secrets.PROD_DB_SERVER }}
          DB_DATABASE: ${{ secrets.PROD_DB_DATABASE }}
          DB_USER: ${{ secrets.PROD_DB_USER }}
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_TLS: false

  critical-workflow-tests:
    name: Critical Workflow Validation
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run critical workflows
        run: npm run test:workflows
        env:
          BASE_URL: http://localhost:3000
          DB_SERVER: ${{ secrets.PROD_DB_SERVER }}
          DB_DATABASE: ${{ secrets.PROD_DB_DATABASE }}
          DB_USER: ${{ secrets.PROD_DB_USER }}
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_TLS: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: prod-workflow-tests
          path: test-results/
          retention-days: 90

  security-final-scan:
    name: Final Security Scan
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Run npm audit
        run: npm audit --audit-level=critical

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'github-cicd-demo'
          path: '.'
          format: 'HTML'

  backup-production:
    name: Backup Production Database
    runs-on: ubuntu-latest
    needs: [full-test-suite, critical-workflow-tests, security-final-scan]
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Create database backup
        run: |
          echo "Creating production database backup..."
          # Azure SQL backup command would go here
          az sql db export \
            --resource-group ${{ secrets.PROD_RESOURCE_GROUP }} \
            --server ${{ secrets.PROD_DB_SERVER }} \
            --name ${{ secrets.PROD_DB_DATABASE }} \
            --admin-user ${{ secrets.PROD_DB_USER }} \
            --admin-password ${{ secrets.PROD_DB_PASSWORD }} \
            --storage-key-type StorageAccessKey \
            --storage-key ${{ secrets.STORAGE_KEY }} \
            --storage-uri "https://backups.blob.core.windows.net/backups/db-backup-$(date +%Y%m%d-%H%M%S).bacpac"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: backup-production
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci --production

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Enable maintenance mode
        run: |
          az webapp config appsettings set \
            --resource-group ${{ secrets.PROD_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --settings MAINTENANCE_MODE=true

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: .

      - name: Run database migrations
        run: |
          node src/database/migrate.js
        env:
          DB_SERVER: ${{ secrets.PROD_DB_SERVER }}
          DB_DATABASE: ${{ secrets.PROD_DB_DATABASE }}
          DB_USER: ${{ secrets.PROD_DB_USER }}
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}

      - name: Warm up application
        run: |
          echo "Warming up application..."
          sleep 30
          curl https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health

      - name: Disable maintenance mode
        run: |
          az webapp config appsettings delete \
            --resource-group ${{ secrets.PROD_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --setting-names MAINTENANCE_MODE

  post-deployment-validation:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Wait for deployment stabilization
        run: sleep 120

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health)
          if [ $response -ne 200 ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed"

      - name: Smoke tests
        run: |
          # Test critical endpoints
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/ || exit 1
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/products || exit 1
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health || exit 1
          echo "All smoke tests passed"

      - name: Performance baseline check
        run: |
          response_time=$(curl -o /dev/null -s -w '%{time_total}' https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/)
          echo "Response time: $response_time seconds"
          
          # Fail if response time > 3 seconds
          if (( $(echo "$response_time > 3.0" | bc -l) )); then
            echo "Response time too high: $response_time seconds"
            exit 1
          fi

  create-production-release:
    name: Create Production Release
    runs-on: ubuntu-latest
    needs: post-deployment-validation
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Create production release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: prod-${{ inputs.release_tag }}
          release_name: Production Release ${{ inputs.release_tag }}
          body: |
            ðŸš€ Production Deployment
            
            Release: ${{ inputs.release_tag }}
            Deployed: $(date +'%Y-%m-%d %H:%M:%S UTC')
            Environment: Production
            URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
            
            This release has been successfully deployed to production and passed all validation checks.
          draft: false
          prerelease: false

  monitor-deployment:
    name: Monitor Deployment
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Monitor for 15 minutes
        run: |
          echo "Monitoring deployment for 15 minutes..."
          for i in {1..15}; do
            sleep 60
            response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health)
            echo "Minute $i: Health check status $response"
            
            if [ $response -ne 200 ]; then
              echo "Health check failed at minute $i"
              exit 1
            fi
          done
          echo "15-minute monitoring completed successfully"

  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [post-deployment-validation, create-production-release]
    if: always()
    steps:
      - name: Deployment notification
        run: |
          echo "==================================="
          echo "Production Deployment Complete"
          echo "==================================="
          echo "Release: ${{ inputs.release_tag }}"
          echo "Status: ${{ needs.post-deployment-validation.result }}"
          echo "URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "==================================="
